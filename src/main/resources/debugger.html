<!-- Debug Toggle Button -->
<button id="debug-toggle" style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; background: rgba(0, 122, 204, 0.1); color: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 10px; border-radius: 3px; cursor: pointer; font-family: monospace; font-size: 10px; box-shadow: none; transition: all 0.3s ease;">
  F10
</button>

<!-- Splitter -->
<div id="debug-splitter" style="position: fixed; bottom: 300px; left: 0; width: 100%; height: 5px; background: #444; cursor: row-resize; z-index: 9998; display: none;">
  <div style="position: absolute; top: 1px; left: 50%; transform: translateX(-50%); width: 50px; height: 3px; background: #666; border-radius: 2px;"></div>
</div>

<div id="debug-container">
  <div class="debug-tabs">
    <button class="tab-button active" data-tab="console">Console</button>
    <button class="tab-button" data-tab="gson">MVC</button>
    <button class="tab-button" data-tab="request">Request</button>
    <button id="debug-close" style="background: #f44747; border: none; color: white; padding: 8px 12px; cursor: pointer; border-radius: 3px; margin-left: auto;">Ã—</button>
  </div>
  
  <div id="console-tab" class="tab-content active">
    <div class="debug-header">
      <span>FusionKit Debug Console</span>
      <button id="clear-console">Clear</button>
    </div>
    <div id="debug-messages"></div>
    <input id="debug-input" placeholder="Enter command... (press Enter)" />
  </div>
  
  <div id="gson-tab" class="tab-content">
    <div class="debug-header">
      <span>FusionKit MVC Data</span>
      <div>
        <button id="clear-gson">Clear</button>
      </div>
    </div>
    <div class="resize-container">
      <div id="gson-content" class="json-viewer">Loading model data...</div>
      <div class="resize-handle"></div>
    </div>
  </div>
  
  <div id="request-tab" class="tab-content">
    <div class="debug-header">
      <span>FusionKit Request Data</span>
      <div>
        <button id="clear-request">Clear</button>
      </div>
    </div>
    <div class="resize-container">
      <div id="request-content" class="json-viewer">Loading request data...</div>
      <div class="resize-handle"></div>
    </div>
  </div>
</div>

<style>
#debug-toggle:hover {
  background: rgba(0, 122, 204, 0.3);
  color: rgba(255, 255, 255, 0.7);
  border-color: rgba(255, 255, 255, 0.3);
  transform: scale(1.02);
}

#debug-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 400px;
  background: #1e1e1e;
  color: #ddd;
  font-family: monospace;
  font-size: 13px;
  border-top: 2px solid #444;
  display: none;
  flex-direction: column;
  z-index: 9999;
  overflow: hidden;
}

#debug-container.visible {
  display: flex;
}

.debug-tabs {
  display: flex;
  background: #2d2d2d;
  border-bottom: 1px solid #444;
  align-items: center;
}

.tab-button {
  background: #2d2d2d;
  border: none;
  color: #aaa;
  padding: 8px 16px;
  cursor: pointer;
  border-right: 1px solid #444;
  transition: all 0.2s;
}

.tab-button:hover {
  background: #3d3d3d;
  color: #fff;
}

.tab-button.active {
  background: #1e1e1e;
  color: #fff;
  border-bottom: 2px solid #007acc;
}

.tab-content {
  display: none;
  flex: 1;
  flex-direction: column;
  height: 100%;
}

.tab-content.active {
  display: flex;
}

.debug-header {
  background: #2d2d2d;
  padding: 4px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #444;
}

.debug-header button {
  background: #007acc;
  border: none;
  color: white;
  padding: 4px 8px;
  margin-left: 4px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 11px;
}

.debug-header button:hover {
  background: #005a9e;
}

#debug-messages {
  flex: 1;
  overflow-y: auto;
  padding: 6px 10px;
}

#debug-input {
  border: none;
  background: #2b2b2b;
  color: #fff;
  padding: 6px 10px;
  outline: none;
}

.resize-container {
  flex: 1;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 200px;
  max-height: 100%;
  padding: 0;
  margin: 0;
}

#gson-content, .json-viewer {
  flex: 1;
  background: #1e1e1e;
  border: none;
  color: #ddd;
  padding: 15px 15px 20px 15px;
  font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.5;
  resize: none;
  outline: none;
  white-space: pre;
  overflow: auto;
  min-height: 250px;
  max-width: 100%;
  max-height: calc(100% - 35px);
  box-sizing: border-box;
  display: block;
  width: 100%;
  height: 100%;
  word-break: normal;
  overflow-wrap: normal;
}

.json-key { color: #9cdcfe; }
.json-string { color: #ce9178; }
.json-number { color: #b5cea8; }
.json-boolean { color: #569cd6; }
.json-null { color: #808080; }
.json-bracket { color: #ddd; font-weight: bold; }
.json-brace { color: #ffd700; font-weight: bold; }

.resize-handle {
  position: absolute;
  right: 0;
  bottom: 0;
  width: 15px;
  height: 15px;
  background: #444;
  cursor: nw-resize;
  border-top-left-radius: 3px;
}

.resize-handle:hover {
  background: #666;
}

.log { color: #9cdcfe; }
.warn { color: #ffcc00; }
.error { color: #f44747; }
.info { color: #4fc1ff; }
.eval { color: #b5cea8; }

</style>

<script>
(function() {
  // Debug container toggle functionality with persistence
  const debugToggle = document.getElementById('debug-toggle');
  const debugContainer = document.getElementById('debug-container');
  const debugClose = document.getElementById('debug-close');
  const debugSplitter = document.getElementById('debug-splitter');
  let isDebugVisible = false;
  
  // Persistence keys
  const STORAGE_KEYS = {
    isVisible: 'fusionkit-debug-visible',
    height: 'fusionkit-debug-height',
    activeTab: 'fusionkit-debug-active-tab'
  };

  function showDebugConsole() {
    debugContainer.classList.add('visible');
    debugSplitter.style.display = 'block';
    debugToggle.style.display = 'none';
    isDebugVisible = true;
    
    // Update splitter position
    const containerHeight = debugContainer.offsetHeight;
    debugSplitter.style.bottom = containerHeight + 'px';
    
    // Save state to localStorage
    localStorage.setItem(STORAGE_KEYS.isVisible, 'true');
    
    // Load data once if gson tab is active
    if (document.getElementById('gson-tab').classList.contains('active')) {
      loadGsonDataOnce();
    }
  }

  function hideDebugConsole() {
    debugContainer.classList.remove('visible');
    debugSplitter.style.display = 'none';
    debugToggle.style.display = 'block';
    isDebugVisible = false;
    
    // Save state to localStorage
    localStorage.setItem(STORAGE_KEYS.isVisible, 'false');
  }

  debugToggle.addEventListener('click', showDebugConsole);
  debugClose.addEventListener('click', hideDebugConsole);

  // Splitter resize functionality
  let isResizingSplitter = false;
  let startY = 0;
  let startHeight = 0;

  debugSplitter.addEventListener('mousedown', (e) => {
    isResizingSplitter = true;
    startY = e.clientY;
    startHeight = debugContainer.offsetHeight;
    
    document.addEventListener('mousemove', handleSplitterResize);
    document.addEventListener('mouseup', stopSplitterResize);
    e.preventDefault();
  });

  function handleSplitterResize(e) {
    if (!isResizingSplitter) return;
    
    const deltaY = startY - e.clientY;
    const newHeight = Math.max(150, Math.min(window.innerHeight * 0.8, startHeight + deltaY));
    
    debugContainer.style.height = newHeight + 'px';
    debugSplitter.style.bottom = newHeight + 'px';
    
    // Save height to localStorage
    localStorage.setItem(STORAGE_KEYS.height, newHeight.toString());
  }

  function stopSplitterResize() {
    isResizingSplitter = false;
    document.removeEventListener('mousemove', handleSplitterResize);
    document.removeEventListener('mouseup', stopSplitterResize);
  }

  // Initialize debug console state from localStorage
  function initializeDebugState() {
    // Restore height
    const savedHeight = localStorage.getItem(STORAGE_KEYS.height);
    if (savedHeight) {
      const height = parseInt(savedHeight);
      if (height >= 150 && height <= window.innerHeight * 0.8) {
        debugContainer.style.height = height + 'px';
      }
    }
    
    // Restore active tab
    const savedTab = localStorage.getItem(STORAGE_KEYS.activeTab);
    if (savedTab && (savedTab === 'console' || savedTab === 'gson' || savedTab === 'request')) {
      switchTab(savedTab);
    }
    
    // Restore visibility state
    const savedVisibility = localStorage.getItem(STORAGE_KEYS.isVisible);
    if (savedVisibility === 'true') {
      showDebugConsole();
    }
  }
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (isDebugVisible) {
      const containerHeight = debugContainer.offsetHeight;
      const maxHeight = window.innerHeight * 0.8;
      if (containerHeight > maxHeight) {
        debugContainer.style.height = maxHeight + 'px';
        debugSplitter.style.bottom = maxHeight + 'px';
        localStorage.setItem(STORAGE_KEYS.height, maxHeight.toString());
      }
    }
  });

  // Tab switching functionality
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  function switchTab(tabName) {
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Save active tab to localStorage
    localStorage.setItem(STORAGE_KEYS.activeTab, tabName);
    
    // Load data once when switching to gson tab
    if (tabName === 'gson') {
      loadGsonDataOnce();
    } else if (tabName === 'request') {
      loadRequestDataOnce();
    }
  }
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      switchTab(button.dataset.tab);
    });
  });

  // Console functionality
  const consoleEl = document.getElementById('debug-messages');
  const inputEl = document.getElementById('debug-input');
  const clearConsoleBtn = document.getElementById('clear-console');

  const original = {
    log: console.log,
    warn: console.warn,
    error: console.error,
    info: console.info
  };

  function addMessage(type, msg) {
    const el = document.createElement('div');
    el.className = type;
    el.textContent = `[${type.toUpperCase()}] ${msg}`;
    consoleEl.appendChild(el);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  ['log', 'warn', 'error', 'info'].forEach(type => {
    console[type] = (...args) => {
      original[type].apply(console, args);
      addMessage(type, args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '));
    };
  });

  clearConsoleBtn.addEventListener('click', () => {
    consoleEl.innerHTML = '';
  });

  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const cmd = inputEl.value.trim();
      if (!cmd) return;
      addMessage('eval', `> ${cmd}`);
      try {
        const result = eval(cmd);
        addMessage('log', result);
      } catch (err) {
        addMessage('error', err.message);
      }
      inputEl.value = '';
    }
  });

  // Gson debug functionality with auto-loading and syntax highlighting
  const gsonContentEl = document.getElementById('gson-content');
  const clearGsonBtn = document.getElementById('clear-gson');
  
  // JSON syntax highlighter
  function syntaxHighlight(json) {
    if (typeof json !== 'string') {
      json = JSON.stringify(json, null, 2);
    }
    
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
      let cls = 'json-number';
      if (/^"/.test(match)) {
        if (/:$/.test(match)) {
          cls = 'json-key';
        } else {
          cls = 'json-string';
        }
      } else if (/true|false/.test(match)) {
        cls = 'json-boolean';
      } else if (/null/.test(match)) {
        cls = 'json-null';
      }
      return '<span class="' + cls + '">' + match + '</span>';
    }).replace(/(\{|\})/g, '<span class="json-brace">$1</span>')
      .replace(/(\[|\])/g, '<span class="json-bracket">$1</span>');
  }
  
  async function loadGsonDebugData() {
    try {
      gsonContentEl.textContent = 'Loading model data...';
      
      const response = await fetch('/fusion/debug?key=%key%');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      
      // Try to parse and format JSON
      try {
        const parsed = JSON.parse(text);
        const formatted = JSON.stringify(parsed, null, 2);
        gsonContentEl.innerHTML = syntaxHighlight(formatted);
        addMessage('info', 'Model data loaded and formatted');
      } catch {
        // If not JSON, display as-is with basic highlighting
        gsonContentEl.innerHTML = '<span class="json-string">' + text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
        addMessage('warn', 'Model data loaded (not JSON format)');
      }
      
    } catch (error) {
      gsonContentEl.innerHTML = `<span class="json-null">Error loading debug data: ${error.message}</span>`;
      addMessage('error', `Failed to load model data: ${error.message}`);
    }
  }
  
  // Track if data has been loaded
  let gsonDataLoaded = false;
  
  function loadGsonDataOnce() {
    if (!gsonDataLoaded) {
      loadGsonDebugData();
      gsonDataLoaded = true;
    }
  }
  
  clearGsonBtn.addEventListener('click', () => {
    gsonContentEl.innerHTML = '<span class="json-null">Model data cleared</span>';
    gsonDataLoaded = false; // Allow reloading if needed
  });

  // Request debug functionality with auto-loading and syntax highlighting
  const requestContentEl = document.getElementById('request-content');
  const clearRequestBtn = document.getElementById('clear-request');
  
  async function loadRequestDebugData() {
    try {
      requestContentEl.textContent = 'Loading request data...';
      
      const response = await fetch('/fusion/request?key=%key%');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      
      // Try to parse and format JSON
      try {
        const parsed = JSON.parse(text);
        const formatted = JSON.stringify(parsed, null, 2);
        requestContentEl.innerHTML = syntaxHighlight(formatted);
        addMessage('info', 'Request data loaded and formatted');
      } catch {
        // If not JSON, display as-is with basic highlighting
        requestContentEl.innerHTML = '<span class="json-string">' + text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
        addMessage('warn', 'Request data loaded (not JSON format)');
      }
      
    } catch (error) {
      requestContentEl.innerHTML = `<span class="json-null">Error loading request data: ${error.message}</span>`;
      addMessage('error', `Failed to load request data: ${error.message}`);
    }
  }
  
  // Track if request data has been loaded
  let requestDataLoaded = false;
  
  function loadRequestDataOnce() {
    if (!requestDataLoaded) {
      loadRequestDebugData();
      requestDataLoaded = true;
    }
  }
  
  clearRequestBtn.addEventListener('click', () => {
    requestContentEl.innerHTML = '<span class="json-null">Request data cleared</span>';
    requestDataLoaded = false; // Allow reloading if needed
  });
  
  // Resize functionality for Gson textarea (corner resize handle)
  const resizeHandle = document.querySelector('.resize-handle');
  let isResizingTextarea = false;
  
  resizeHandle.addEventListener('mousedown', (e) => {
    isResizingTextarea = true;
    document.addEventListener('mousemove', handleTextareaResize);
    document.addEventListener('mouseup', stopTextareaResize);
    e.preventDefault();
  });
  
  function handleTextareaResize(e) {
    if (!isResizingTextarea) return;
    
    const gsonTab = document.getElementById('gson-tab');
    const rect = gsonTab.getBoundingClientRect();
    const newWidth = Math.max(200, e.clientX - rect.left);
    const newHeight = Math.max(100, rect.bottom - e.clientY);
    
    // Resize the container instead of individual element
    const resizeContainer = gsonTab.querySelector('.resize-container');
    resizeContainer.style.width = newWidth + 'px';
    resizeContainer.style.height = newHeight + 'px';
  }
  
  function stopTextareaResize() {
    isResizingTextarea = false;
    document.removeEventListener('mousemove', handleTextareaResize);
    document.removeEventListener('mouseup', stopTextareaResize);
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // F10, F12 or Ctrl+` to toggle debug console
    if (e.key === 'F10' || e.key === 'F12' || (e.ctrlKey && e.key === '`')) {
      e.preventDefault();
      if (isDebugVisible) {
        hideDebugConsole();
      } else {
        showDebugConsole();
      }
    }
    // Escape to close debug console
    else if (e.key === 'Escape' && isDebugVisible) {
      hideDebugConsole();
    }
  });

  // Initialize the debug console state on page load
  initializeDebugState();

  console.log('Loaded view (%key%)');
})();</script>

</script>